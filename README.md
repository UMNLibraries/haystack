# Haystack

*Search a Large Zipped JSONL File with Regular Expressions and Save Results in Batches of JSON*

## Install

 ```
$ git clone https://github.com/UMNLibraries/haystack.git
$ cd haystack
$ yarn install
$ node run.js --help
```

Download a zipped JSONL file (e.g. [DPLA bulk downloads](https://pro.dp.la/developers/bulk-download))

## Run

Run and store records locally:

`node run.js -i 'EXAMPLE.dpla.json.gz' -r 'https://lib-metl-prd-01.oit.umn.edu/lookups/34.json' -d 'batches'`

Run and store records in an AWS S3 bucket:

`node run.js -i 'EXAMPLE.dpla.json.gz' -r 'https://lib-metl-prd-01.oit.umn.edu/lookups/34.json' -b 'mah-bucket'`

(requires [AWS Environmental Variable Credentials]([https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/loading-node-credentials-environment.html) to be present.

Note: a `keys.json` file containing all keys pushed to the given bucket is itself pushed to the bucket. This is done to facilitate mass processing of records (rather than forcing clients to iterate individually through record keys using the AWS S3 API).

### -r regexURL JSON File Description:

* "include":  Include records that match any of the given RegEx patterns
  * "flags": RegEx [flags](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp)
  * "patterns": An array of regular expressions that are "ORed" together (with the pipe character "|").
* "exclude": A set of more complex patterns to filter out false positives generated by "include" patterns
  * "allMustMatch": batches of patterns can either require that all patterns match (boolean AND) or just one (boolean OR)

```JSON
  {
    "include": {
      "flags": "i",
      "patterns": [
        "Affirmative action"
      ]
    },
    "exclude": [
      {
        "allMustMatch": true,
        "patterns": [
          "Bears"
        ],
        "flags": "i"
      }
    ]
  }
```


